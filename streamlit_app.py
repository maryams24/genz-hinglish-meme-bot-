# Code Generated by Sidekick is for learning and experimentation purposes only.
import base64
import datetime as dt
import io
import math
import random
import re
import wave

import streamlit as st
import streamlit.components.v1 as components

# =============================
# Config
# =============================
st.set_page_config(page_title="Office Chatbot (FAAH + Celebrate)", layout="centered")
random.seed()

# =============================
# UI (dark bg + readable glass surfaces)
# =============================
st.markdown(
    """
<style>
/* Code Generated by Sidekick is for learning and experimentation purposes only. */
.stApp{
  background:
    radial-gradient(900px 520px at 12% 8%, rgba(98,181,229,0.22), transparent 60%),
    radial-gradient(800px 520px at 92% 12%, rgba(134,188,37,0.18), transparent 62%),
    radial-gradient(800px 520px at 50% 92%, rgba(255,209,0,0.10), transparent 62%),
    linear-gradient(180deg, #0B1220 0%, #0A0F16 65%, #0B1220 100%);
}
:root{
  --ink:#0B1220;
  --muted:#4B5563;
  --line:rgba(11,18,32,.10);
  --glass:rgba(255,255,255,.92);
  --glass2:rgba(255,255,255,.80);
  --shadow: 0 14px 46px rgba(0,0,0,.22);
}
.block-container{ padding-top: 1.1rem; max-width: 980px; }

.hero{
  border: 1px solid var(--line);
  background: var(--glass);
  border-radius: 18px;
  padding: 14px 16px 12px 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.title{ font-size: 1.45rem; font-weight: 900; margin:0; color: var(--ink) !important; }
.sub{ margin-top: 6px; font-size: .95rem; color: var(--muted) !important; }
.kbd{
  display:inline-block; padding: 2px 8px; border-radius: 10px;
  border: 1px solid var(--line); background: rgba(255,255,255,.70);
  font-size: .84rem; margin-right: 6px; color: var(--ink) !important;
}

.card{
  margin-top: 12px;
  border: 1px solid var(--line);
  background: var(--glass2);
  border-radius: 18px;
  padding: 12px 12px 8px 12px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.small{ font-size:.90rem; color: var(--muted) !important; }

section[data-testid="stSidebar"]{
  background: rgba(255,255,255,.86) !important;
  border-right: 1px solid var(--line);
  backdrop-filter: blur(10px);
}

div[data-testid="stChatMessage"]{
  border: 1px solid var(--line) !important;
  background: rgba(255,255,255,.92) !important;
  border-radius: 16px !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.12);
}
div[data-testid="stChatMessage"] *{ color: var(--ink) !important; }

div[data-testid="stChatInput"]{
  border: 1px solid var(--line) !important;
  border-radius: 14px !important;
  background: rgba(255,255,255,.92) !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.12);
}
div[data-testid="stChatInput"] textarea{ color: var(--ink) !important; }
</style>
""",
    unsafe_allow_html=True,
)

# =============================
# State
# =============================
def ss_init():
    if "messages" not in st.session_state:
        st.session_state.messages = []
    if "sound_unlocked" not in st.session_state:
        st.session_state.sound_unlocked = False
    if "audio_nonce" not in st.session_state:
        st.session_state.audio_nonce = 0
    if "faah_upload_bytes" not in st.session_state:
        st.session_state.faah_upload_bytes = None
        st.session_state.faah_upload_mime = None
        st.session_state.faah_upload_name = None
    if "_queued_input" not in st.session_state:
        st.session_state._queued_input = None

ss_init()

# =============================
# Audio helpers (FAAH upload + synth fallback)
# =============================
AUTOPLAY_NOTE = "If sound doesn‚Äôt autoplay: click **Enable Sound** once (browser rule)."

def _to_wav_bytes(sr: int, samples_f32: list[float]) -> bytes:
    pcm = bytearray()
    for x in samples_f32:
        x = max(-1.0, min(1.0, float(x)))
        i = int(x * 32767.0)
        pcm += int(i).to_bytes(2, "little", signed=True)
    buf = io.BytesIO()
    with wave.open(buf, "wb") as wf:
        wf.setnchannels(1)
        wf.setsampwidth(2)
        wf.setframerate(sr)
        wf.writeframes(bytes(pcm))
    return buf.getvalue()

def make_silence_wav(ms: int = 80) -> bytes:
    sr = 22050
    n = int(sr * (ms / 1000.0))
    return _to_wav_bytes(sr, [0.0] * n)

def make_faah_synth_wav() -> bytes:
    # Short comedic down-sweep + noise burst
    sr, dur = 22050, 0.26
    n = int(sr * dur)
    out = []
    f0, f1 = 760.0, 150.0
    phase = 0.0
    for i in range(n):
        t = i / sr
        freq = f0 * ((f1 / f0) ** (t / dur))
        phase += (2.0 * math.pi * freq) / sr
        sweep = math.sin(phase)
        noise = (random.random() * 2.0 - 1.0) * 0.09
        env = math.exp(-8.5 * t)
        out.append(math.tanh(2.2 * (0.92 * sweep + noise)) * env)
    return _to_wav_bytes(sr, out)

def get_faah_bytes() -> tuple[bytes, str, str]:
    if st.session_state.faah_upload_bytes:
        return (
            st.session_state.faah_upload_bytes,
            st.session_state.faah_upload_mime or "audio/mpeg",
            f"FAAH (uploaded: {st.session_state.faah_upload_name})",
        )
    return (make_faah_synth_wav(), "audio/wav", "FAAH (synth)")

def js_play_audio_now(audio_bytes: bytes, mime: str, nonce: int, volume: float = 1.0):
    # Uses JS Audio() play. Works ONLY after a user gesture in most browsers.
    b64 = base64.b64encode(audio_bytes).decode("ascii")
    vol = max(0.0, min(1.0, float(volume)))
    html = f"""
    <script>
      (async () => {{
        try {{
          const a = new Audio("data:{mime};base64,{b64}");
          a.volume = {vol};
          await a.play();
        }} catch (e) {{
          console.log("autoplay blocked", e);
        }}
      }})();
    </script>
    """
    components.html(html, height=0, width=0)

def play_faah_immediately(try_autoplay: bool):
    b, m, label = get_faah_bytes()
    st.caption(label)
    st.audio(b, format=m)  # always show a clickable fallback player
    if try_autoplay and st.session_state.sound_unlocked:
        st.session_state.audio_nonce += 1
        js_play_audio_now(b, m, st.session_state.audio_nonce, volume=1.0)
    elif try_autoplay and (not st.session_state.sound_unlocked):
        st.info(AUTOPLAY_NOTE)

# =============================
# FAAH triggers (stressful / funny corporate pain)
# =============================
TRIGGERS = [
    r"\bclient\b.*\bnew ideas?\b",
    r"\bclient\b.*\bmore ideas?\b",
    r"\bclient\b.*\bbrainstorm\b",
    r"\bclient\b.*\bfresh ideas?\b",
    r"\bclient\b.*\binnovate\b",
    r"\bclient wants new ideas\b",
    r"\bby eod\b|\beod\b",
    r"\basap\b",
    r"\bsmall change\b",
    r"\bquick deck\b",
    r"\bquick call\b|\bhop on\b.*\bcall\b",
    r"\bcircle back\b",
    r"\bkeep it simple\b.*\bimpactful\b",
    r"\bmake it pop\b",
    r"\bone last thing\b",
    r"\bpls fix\b|\bplz fix\b|\bplease fix\b",
    r"\brebaseline\b",
    r"\bscope change\b|\bchange request\b",
]

def should_play_faah(text: str) -> bool:
    t = (text or "").lower().strip()
    return any(re.search(p, t) for p in TRIGGERS)

# =============================
# Celebrate triggers (good news)
# =============================
GOOD_NEWS_PATTERNS = [
    r"\bgood news\b",
    r"\bwe won\b|\bwe won the\b",
    r"\bapproved\b|\bapproval\b|\bgreen light\b",
    r"\bsigned\b|\bcontract signed\b|\bpo issued\b",
    r"\bgo[- ]live\b|\blaunch(ed)?\b",
    r"\bkudos\b|\bshoutout\b|\bappreciation\b",
    r"\bclient loved\b|\bclient happy\b|\bpositive feedback\b",
    r"\buat passed\b|\bpassed\b.*\buat\b",
]

def is_good_news(text: str) -> bool:
    t = (text or "").lower().strip()
    return any(re.search(p, t) for p in GOOD_NEWS_PATTERNS)

# =============================
# Corporate Hinglish jokes (light)
# =============================
FAAH_QUIPS = [
    "FAAH. ‚ÄòSmall change‚Äô ka matlab: full redesign, bas emotionally.",
    "FAAH. Client ne bola ‚Äòquick deck‚Äô‚Äîcalendar ne bola ‚Äògood luck‚Äô.",
    "FAAH. ‚ÄòEOD‚Äô is a feeling, not a time. Yaar.",
    "FAAH. ‚ÄòKeep it simple‚Äô + ‚Äòmake it impactful‚Äô = do bosses, one brain.",
    "FAAH. ‚ÄòQuick call‚Äô = 5 mins + 43 mins of ‚Äúcontext setting‚Äù.",
    "FAAH. ‚ÄòCircle back‚Äô = round-trip ticket to nowhere, bhai.",
    "FAAH. ‚ÄòLow effort, high impact‚Äô‚Äîhaan, like magic.",
    "FAAH. ‚ÄòOne last thing‚Äô‚Äîaur phir last ke 7 cousins aate hain.",
    "FAAH. ‚ÄòMake it pop‚Äô‚ÄîPowerPoint bhi therapist maang raha hai.",
    "FAAH. ‚ÄòNew ideas‚Äô with same budget‚Äîinnovation ka jugaad edition.",
    "FAAH. ‚ÄòASAP‚Äô bola, matlab aaj raat ka plan cancel.",
]
GOOD_NEWS_QUIPS = [
    "W. Aaj toh deliverable ne smile diya. Shabaash.",
    "Client happy? Matlab universe thoda balance mein hai.",
    "Green light mil gaya‚Äîab bas scope ko green mat kar dena.",
    "UAT passed? Party nahi, but ek chai toh banti hai.",
]
TINY_NORMAL_QUIPS = [
    "Noted‚Äîclean, crisp, client-safe.",
    "Got it. We‚Äôll keep it short and usable.",
    "Okay. No drama, only deliverables.",
    "Done. We‚Äôll align, then execute.",
]

# =============================
# Office response engine
# =============================
def office_reply(user_text: str, faah_hit: bool, good_hit: bool) -> str:
    t = (user_text or "").strip()
    low = t.lower()

    if low == "/help":
        return (
            "Commands:\n"
            "- /faah (play FAAH)\n"
            "- /help\n\n"
            "Ask for: email / standup / agenda / RAID / notes / slides / workplan."
        )
    if low == "/faah":
        return "FAAH triggered (manual)."

    if good_hit:
        return (
            f"{random.choice(GOOD_NEWS_QUIPS)}\n\n"
            "Batao: kya approve hua + metric + next step. Main client-safe update bana dunga."
        )

    if any(k in low for k in ["standup", "status update", "daily update", "scrum"]):
        return (
            f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
            "Template:\nDone:\n- \n\nNext:\n- \n\nBlockers/Risks:\n- \n\nAsk (if any):\n- "
        )

    if any(k in low for k in ["email", "mail", "slack", "teams", "message"]):
        return (
            f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
            "Tell me: audience, ask, deadline, tone. Draft template:\n\n"
            "Subject: [Action] [Topic] by [Date]\n\n"
            "Hi [Name],\n"
            "Sharing a quick update on [topic].\n\n"
            "Status:\n- \n\n"
            "Next steps (Owner | Date):\n- \n\n"
            "Decision/ask:\n- \n\n"
            "Thanks,\n[Your name]"
        )

    if any(k in low for k in ["agenda", "meeting agenda"]):
        return (
            f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
            "30-min agenda:\n1) Outcomes (2)\n2) Progress (8)\n3) Decisions (8)\n4) Risks (6)\n5) Next steps (6)\n\n"
            "Topic + attendees bhejo, main tailor kar dunga."
        )

    if any(k in low for k in ["raid", "risk", "issue", "blocker", "dependency", "assumption"]):
        return (
            f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
            "RAID entry:\nType:\nDescription:\nImpact:\nLikelihood:\nOwner:\nMitigation:\nDue:\nStatus:\n\nPaste your sentence."
        )

    if any(k in low for k in ["slides", "deck", "ppt", "storyline"]):
        return (
            f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
            "6-slide storyline:\n1) Context\n2) Current state\n3) Insights\n4) Options + trade-offs\n5) Recommendation\n6) Roadmap + risks\n\n"
            "Audience + decision + time tell karo."
        )

    if faah_hit:
        return (
            f"{random.choice(FAAH_QUIPS)}\n\n"
            "Fast idea structure (client-safe):\n"
            "A) Optimize (low risk)\nB) Enable (medium)\nC) Transform (bold)\n\n"
            "Bas 3 inputs do: objective, constraints, decision-maker."
        )

    return (
        f"{random.choice(TINY_NORMAL_QUIPS)}\n\n"
        "Tell me: email / standup / agenda / RAID / slides. Hinglish bhi chalega."
    )

# =============================
# Sidebar controls
# =============================
with st.sidebar:
    st.subheader("FAAH sound")
    up = st.file_uploader("Upload faah.mp3 or faah.wav", type=["mp3", "wav"])
    if up is not None:
        st.session_state.faah_upload_bytes = up.getvalue()
        st.session_state.faah_upload_name = up.name
        st.session_state.faah_upload_mime = up.type or ("audio/mpeg" if up.name.lower().endswith(".mp3") else "audio/wav")
        st.success(f"Loaded: {up.name}")

    try_autoplay = st.toggle("Attempt autoplay", value=True)

    if st.button("Enable Sound (required once)"):
        # Browser needs a user gesture; we play a tiny silent audio to "unlock".
        st.session_state.sound_unlocked = True
        st.success("Sound unlocked for this session.")
        st.session_state.audio_nonce += 1
        js_play_audio_now(make_silence_wav(80), "audio/wav", st.session_state.audio_nonce, volume=0.0)

    st.caption("Tip: FAAH triggers on ‚ÄúClient wants new ideas by EOD‚Äù, ‚ÄúASAP‚Äù, ‚Äúsmall change‚Äù, etc.")

    st.divider()
    st.subheader("Celebrate FX (good news)")
    celebrate_fx = st.radio("Effect", ["Balloons", "Snow (sprinkle)", "Fire toast only", "Off"], index=0)

    st.divider()
    st.subheader("Shortcuts")
    if st.button("Client wants new ideas by EOD (FAAH)"):
        st.session_state._queued_input = "Client wants new ideas by EOD, same budget."
    if st.button("‚ÄòSmall change‚Äô make it pop (FAAH)"):
        st.session_state._queued_input = "It‚Äôs a small change, just make it pop."
    if st.button("Good news: approved (Celebrate)"):
        st.session_state._queued_input = "Good news! Client approved the approach."
    if st.button("Play FAAH now"):
        st.session_state._queued_input = "/faah"

# =============================
# Header
# =============================
st.markdown(
    """
<div class="hero">
  <div class="title">Office Chatbot (Hinglish) ‚Ä¢ FAAH on stress</div>
  <div class="sub">
    FAAH plays instantly on stressful/funny text like:
    <span class="kbd">Client wants new ideas by EOD</span>
    <span class="kbd">ASAP</span>
    <span class="kbd">small change</span>
    <span class="kbd">make it pop</span>
    <br><br>
    Good news triggers balloons/sprinkle:
    <span class="kbd">approved</span>
    <span class="kbd">we won</span>
    <span class="kbd">go-live</span>
  </div>
</div>
""",
    unsafe_allow_html=True,
)

# =============================
# Input (chat_input is pinned bottom anyway)
# =============================
queued = st.session_state.get("_queued_input")
if queued:
    st.session_state._queued_input = None

user_text = queued or st.chat_input("Type here‚Ä¶ (e.g., Client wants new ideas by EOD)")

# =============================
# Handle message (NO manual st.rerun)
# =============================
faah_hit = False
good_hit = False

if user_text:
    ts = dt.datetime.now().strftime("%H:%M")
    st.session_state.messages.append({"role": "user", "content": user_text, "ts": ts})

    faah_hit = (user_text.strip().lower() == "/faah") or should_play_faah(user_text)
    good_hit = is_good_news(user_text)

    reply = office_reply(user_text, faah_hit=faah_hit, good_hit=good_hit)
    st.session_state.messages.append({"role": "assistant", "content": reply, "ts": ts})

# =============================
# FX (good news)
# =============================
if good_hit and celebrate_fx != "Off":
    if celebrate_fx == "Balloons":
        st.toast("üî• Big W. Approved / go-live vibes.")
        st.balloons()
    elif celebrate_fx.startswith("Snow"):
        st.toast("‚ú® Sprinkle time. Good news locked.")
        st.snow()
    elif celebrate_fx.startswith("Fire"):
        st.toast("üî• Fire. Good news just dropped.")

# =============================
# FAAH sound (plays immediately on the same run)
# =============================
if faah_hit:
    play_faah_immediately(try_autoplay=try_autoplay)

# =============================
# Chat history
# =============================
st.markdown('<div class="card">', unsafe_allow_html=True)
st.markdown('<div class="small">Office-only. Hinglish allowed. Try the stress phrases for FAAH.</div>', unsafe_allow_html=True)

for m in st.session_state.messages:
    with st.chat_message(m["role"]):
        st.markdown(m["content"])
        st.markdown(f'<div class="small">{m["ts"]}</div>', unsafe_allow_html=True)

st.markdown("</div>", unsafe_allow_html=True)
