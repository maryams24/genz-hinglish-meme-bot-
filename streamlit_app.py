# Code Generated by Sidekick is for learning and experimentation purposes only.
import base64
import datetime as dt
import io
import math
import random
import re
import wave

import streamlit as st
import streamlit.components.v1 as components

# =============================
# Config
# =============================
st.set_page_config(page_title="Office Copilot (FAAH)", layout="centered")
random.seed()

# =============================
# UI (clean office look)
# =============================
st.markdown(
    """
<style>
/* Code Generated by Sidekick is for learning and experimentation purposes only. */
.stApp{
  background:
    radial-gradient(900px 520px at 12% 8%, rgba(98,181,229,0.20), transparent 60%),
    radial-gradient(800px 520px at 92% 12%, rgba(134,188,37,0.18), transparent 62%),
    linear-gradient(180deg, #0B1220 0%, #0A0F16 65%, #0B1220 100%);
}
:root{
  --ink:#0B1220;
  --muted:#4B5563;
  --line:rgba(11,18,32,.10);
  --glass:rgba(255,255,255,.92);
  --glass2:rgba(255,255,255,.80);
  --shadow: 0 14px 46px rgba(0,0,0,.22);
}
.block-container{ padding-top: 1.1rem; max-width: 980px; }

.hero{
  border: 1px solid var(--line);
  background: var(--glass);
  border-radius: 18px;
  padding: 14px 16px 12px 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.title{ font-size: 1.45rem; font-weight: 900; margin:0; color: var(--ink) !important; }
.sub{ margin-top: 6px; font-size: .95rem; color: var(--muted) !important; }
.kbd{
  display:inline-block; padding: 2px 8px; border-radius: 10px;
  border: 1px solid var(--line); background: rgba(255,255,255,.70);
  font-size: .84rem; margin-right: 6px; color: var(--ink) !important;
}

.card{
  margin-top: 12px;
  border: 1px solid var(--line);
  background: var(--glass2);
  border-radius: 18px;
  padding: 12px 12px 8px 12px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.small{ font-size:.90rem; color: var(--muted) !important; }

section[data-testid="stSidebar"]{
  background: rgba(255,255,255,.84) !important;
  border-right: 1px solid var(--line);
  backdrop-filter: blur(10px);
}

div[data-testid="stChatMessage"]{
  border: 1px solid var(--line) !important;
  background: rgba(255,255,255,.92) !important;
  border-radius: 16px !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.12);
}
div[data-testid="stChatMessage"] *{ color: var(--ink) !important; }
div[data-testid="stChatInput"]{
  border: 1px solid var(--line) !important;
  border-radius: 14px !important;
  background: rgba(255,255,255,.92) !important;
  box-shadow: 0 10px 28px rgba(0,0,0,.12);
}
div[data-testid="stChatInput"] textarea{ color: var(--ink) !important; }
</style>
""",
    unsafe_allow_html=True,
)

# =============================
# State
# =============================
def ss_init():
    if "messages" not in st.session_state:
        st.session_state.messages = []
    if "sound_enabled" not in st.session_state:
        st.session_state.sound_enabled = False
    if "sound_error_once" not in st.session_state:
        st.session_state.sound_error_once = False
    if "pending_audio" not in st.session_state:
        st.session_state.pending_audio = None  # {bytes,mime,label,autoplay,nonce}
    if "audio_nonce" not in st.session_state:
        st.session_state.audio_nonce = 0
    if "faah_upload_bytes" not in st.session_state:
        st.session_state.faah_upload_bytes = None
        st.session_state.faah_upload_mime = None
        st.session_state.faah_upload_name = None

ss_init()

# =============================
# Audio helpers
# =============================
DEFAULT_SOUND_ERROR = "SoundBlockedError: click ‘Enable Sound’ once, then send again."

def _to_wav_bytes(sr: int, samples_f32: list[float]) -> bytes:
    pcm = bytearray()
    for x in samples_f32:
        x = max(-1.0, min(1.0, float(x)))
        i = int(x * 32767.0)
        pcm += int(i).to_bytes(2, "little", signed=True)
    buf = io.BytesIO()
    with wave.open(buf, "wb") as wf:
        wf.setnchannels(1)
        wf.setsampwidth(2)
        wf.setframerate(sr)
        wf.writeframes(bytes(pcm))
    return buf.getvalue()

def make_faah_synth_wav() -> bytes:
    # Short comedic down-sweep + slight noise
    sr, dur = 22050, 0.26
    n = int(sr * dur)
    out = []
    f0, f1 = 740.0, 150.0
    phase = 0.0
    for i in range(n):
        t = i / sr
        freq = f0 * ((f1 / f0) ** (t / dur))
        phase += (2.0 * math.pi * freq) / sr
        sweep = math.sin(phase)
        noise = (random.random() * 2.0 - 1.0) * 0.09
        env = math.exp(-8.5 * t)
        out.append(math.tanh(2.2 * (0.92 * sweep + noise)) * env)
    return _to_wav_bytes(sr, out)

def get_faah_bytes() -> tuple[bytes, str, str]:
    if st.session_state.faah_upload_bytes:
        return (
            st.session_state.faah_upload_bytes,
            st.session_state.faah_upload_mime or "audio/mpeg",
            f"FAAH (uploaded: {st.session_state.faah_upload_name})",
        )
    return (make_faah_synth_wav(), "audio/wav", "FAAH (synth)")

def queue_audio(bytes_data: bytes, mime: str, label: str, autoplay: bool):
    st.session_state.audio_nonce += 1
    st.session_state.pending_audio = {
        "bytes": bytes_data,
        "mime": mime,
        "label": label,
        "autoplay": autoplay,
        "nonce": st.session_state.audio_nonce,
    }

def render_autoplay_audio(audio_bytes: bytes, mime: str, nonce: int):
    b64 = base64.b64encode(audio_bytes).decode("ascii")
    html = f"""
    <audio id="faah{nonce}" autoplay>
      <source src="data:{mime};base64,{b64}" type="{mime}">
    </audio>
    <script>
      (function(){{
        const el = document.getElementById("faah{nonce}");
        if(!el) return;
        const p = el.play();
        if(p && p.catch) p.catch(()=>{{}});
      }})();
    </script>
    """
    components.html(html, height=0, width=0)

# =============================
# Sidebar (upload + sound)
# =============================
with st.sidebar:
    st.subheader("FAAH sound")
    up = st.file_uploader("Upload faah.mp3 or faah.wav", type=["mp3", "wav"])
    if up is not None:
        st.session_state.faah_upload_bytes = up.getvalue()
        st.session_state.faah_upload_name = up.name
        st.session_state.faah_upload_mime = up.type or ("audio/mpeg" if up.name.lower().endswith(".mp3") else "audio/wav")
        st.success(f"Loaded: {up.name}")

    attempt_autoplay = st.toggle("Attempt autoplay", value=True)
    if st.button("Enable Sound (click once)"):
        st.session_state.sound_enabled = True
        st.success("Sound enabled.")

    if st.button("Preview FAAH"):
        b, m, label = get_faah_bytes()
        st.caption(label)
        st.audio(b, format=m)

    st.divider()
    st.subheader("Office shortcuts")
    st.caption("Click to insert a prompt.")
    if st.button("Draft: client email (status + next steps)"):
        st.session_state._queued_input = "Draft an email to the client with status and next steps."
    if st.button("Standup update (Done/Next/Blockers)"):
        st.session_state._queued_input = "Help me write a standup update."
    if st.button("Meeting agenda (30 min)"):
        st.session_state._queued_input = "Create a 30-minute meeting agenda for a client check-in."
    if st.button("RAID log entry"):
        st.session_state._queued_input = "Turn this into a RAID log entry: data access is delayed."
    if st.button("Client asked for new ideas (FAAH)"):
        st.session_state._queued_input = "Client is asking for new ideas."

# =============================
# Header
# =============================
st.markdown(
    """
<div class="hero">
  <div class="title">Office Chatbot (with FAAH for “new ideas”)</div>
  <div class="sub">
    Professional help for emails, standups, agendas, RAID, slides, and workplans.
    FAAH plays when you mention the client asking for new ideas / more ideas / brainstorming.
    <br><br>
    <span class="kbd">Try:</span>
    <span class="kbd">Client is asking for new ideas</span>
    <span class="kbd">Draft an email to the client</span>
    <span class="kbd">Help me write a standup update</span>
  </div>
</div>
""",
    unsafe_allow_html=True,
)

# =============================
# FAAH trigger logic
# =============================
IDEATION_PATTERNS = [
    r"\bclient\b.*\bnew ideas?\b",
    r"\bclient\b.*\bmore ideas?\b",
    r"\bclient\b.*\bbrainstorm\b",
    r"\bclient\b.*\binnovate\b",
    r"\bclient\b.*\bfresh ideas?\b",
    r"\bclient\b.*\bnew requirement\b",
    r"\bclient\b.*\bchange request\b",
    r"\bclient\b.*\bscope change\b",
    r"\bclient\b.*\bany ideas\b",
]

def should_play_faah(text: str) -> bool:
    t = (text or "").lower().strip()
    return any(re.search(p, t) for p in IDEATION_PATTERNS)

# =============================
# Office response engine (light humor, not too much)
# =============================
LIGHT_OFFICE_QUIPS = [
    "Two-word horror story: “small change.”",
    "I love “quick question” almost as much as deadlines.",
    "We’ll keep it crisp: facts, decisions, next steps.",
]

def office_reply(user_text: str) -> str:
    t = (user_text or "").strip()
    low = t.lower()

    if should_play_faah(t):
        return (
            f"{random.choice(LIGHT_OFFICE_QUIPS)}\n\n"
            "Got it. To generate client-ready ideas fast, give me:\n"
            "1) objective (what success looks like)\n"
            "2) constraints (time/budget/tech/legal)\n"
            "3) audience (who decides)\n"
            "4) current baseline (what’s already tried)\n\n"
            "Meanwhile, here’s a quick 2-track ideation structure:\n"
            "- Track A (low-risk): optimize process, automate steps, improve reporting, reduce cycle time\n"
            "- Track B (value-upside): new capability, new data/product, new operating model, new partner/vendor\n"
        )

    if any(k in low for k in ["standup", "status update", "status", "daily update"]):
        return (
            "Paste your raw bullets and I’ll tighten them. Template:\n"
            "Done:\n"
            "- \n"
            "Next:\n"
            "- \n"
            "Blockers/Risks:\n"
            "- \n"
            "Ask (if any):\n"
            "- "
        )

    if any(k in low for k in ["email", "mail", "slack", "teams", "message"]):
        return (
            "Tell me: audience, the ask, deadline, and tone (firm/neutral/warm). Draft template:\n\n"
            "Subject: [Action] [Topic] by [Date]\n\n"
            "Hi [Name],\n"
            "Sharing a quick update on [topic].\n\n"
            "Status (as of today):\n"
            "- \n\n"
            "Next steps:\n"
            "- \n\n"
            "Decision/ask:\n"
            "- \n\n"
            "Thanks,\n"
            "[Your name]\n"
        )

    if any(k in low for k in ["agenda", "meeting agenda"]):
        return (
            "30-min client check-in agenda (tight and usable):\n"
            "1) Purpose + desired outcomes (2 min)\n"
            "2) Progress since last time (8 min)\n"
            "3) Decisions needed today (8 min)\n"
            "4) Risks/blockers + mitigations (6 min)\n"
            "5) Next steps + owners + dates (6 min)\n\n"
            "If you tell me the topic, I’ll tailor it."
        )

    if any(k in low for k in ["mom", "minutes", "notes"]):
        return (
            "Meeting notes template (copy/paste):\n"
            "Context:\n"
            "- \n\n"
            "Attendees:\n"
            "- \n\n"
            "Decisions:\n"
            "- \n\n"
            "Action items (Owner | Due | Item):\n"
            "- \n\n"
            "Risks/Issues:\n"
            "- "
        )

    if any(k in low for k in ["raid", "risk", "issue", "blocker"]):
        return (
            "RAID entry format:\n"
            "ID: \n"
            "Type: Risk / Issue / Assumption / Dependency\n"
            "Description: \n"
            "Impact: \n"
            "Likelihood (if risk): Low/Med/High\n"
            "Owner: \n"
            "Mitigation/Next step: \n"
            "Due date: \n"
            "Status: Open / Monitoring / Closed\n\n"
            "Paste your sentence and I’ll convert it."
        )

    if any(k in low for k in ["slides", "deck", "ppt", "storyline"]):
        return (
            "Share audience + decision needed + time limit. Default 6-slide storyline:\n"
            "1) Context and objective\n"
            "2) What we heard / current state\n"
            "3) Key insights (3–5)\n"
            "4) Options (2–3) + trade-offs\n"
            "5) Recommendation + rationale\n"
            "6) Roadmap + risks + asks\n"
        )

    if any(k in low for k in ["timeline", "plan", "workplan", "project plan"]):
        return (
            "Workplan starter (lightweight):\n"
            "Week 1: align scope, stakeholders, success metrics\n"
            "Week 2: current-state + gaps\n"
            "Week 3: options + business case\n"
            "Week 4: recommendation + roadmap\n\n"
            "Tell me timeframe (weeks) and deliverables, I’ll adapt it."
        )

    # Default
    return (
        "Tell me what you need (email / standup / agenda / RAID / slides / workplan). "
        "If you paste the raw text, I’ll rewrite it cleanly."
    )

# =============================
# Render pending audio (if any)
# =============================
if st.session_state.pending_audio is not None:
    p = st.session_state.pending_audio
    st.caption(p["label"])
    if attempt_autoplay and p["autoplay"] and st.session_state.sound_enabled:
        render_autoplay_audio(p["bytes"], p["mime"], p["nonce"])
    st.audio(p["bytes"], format=p["mime"])
    st.session_state.pending_audio = None

# =============================
# Chat
# =============================
st.markdown('<div class="card">', unsafe_allow_html=True)
st.markdown(
    '<div class="small">Office-only chatbot. FAAH triggers on “client asking for new ideas”.</div>',
    unsafe_allow_html=True,
)

for m in st.session_state.messages:
    with st.chat_message(m["role"]):
        st.markdown(m["content"])
        st.markdown(f'<div class="small">{m["ts"]}</div>', unsafe_allow_html=True)

queued = st.session_state.get("_queued_input")
if queued:
    st.session_state._queued_input = None

user_text = queued or st.chat_input("Type here…")
st.markdown("</div>", unsafe_allow_html=True)

# =============================
# Handle message
# =============================
if user_text:
    ts = dt.datetime.now().strftime("%H:%M")
    st.session_state.messages.append({"role": "user", "content": user_text, "ts": ts})

    reply = office_reply(user_text)
    st.session_state.messages.append({"role": "assistant", "content": reply, "ts": ts})

    # Play FAAH ONLY when ideation trigger happens
    if should_play_faah(user_text):
        if attempt_autoplay and (not st.session_state.sound_enabled) and (not st.session_state.sound_error_once):
            st.session_state.sound_error_once = True
            st.error(DEFAULT_SOUND_ERROR)

        b, m, label = get_faah_bytes()
        queue_audio(b, m, label=label, autoplay=attempt_autoplay)

    st.rerun()
